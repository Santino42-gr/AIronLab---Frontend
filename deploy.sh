#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð´Ð»Ñ Ñ€ÐµÐ³.Ñ€Ñƒ Ñ…Ð¾ÑÑ‚Ð¸Ð½Ð³Ð°
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ./deploy.sh

set -e

echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° Ñ€ÐµÐ³.Ñ€Ñƒ..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
if [ ! -f "package.json" ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: package.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸Ð· ÐºÐ¾Ñ€Ð½Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ¾Ð¼Ð¼Ð¸Ñ‡ÐµÐ½Ñ‹
if [ -n "$(git status --porcelain)" ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: ÐµÑÑ‚ÑŒ Ð½ÐµÐ·Ð°ÐºÐ¾Ð¼Ð¼Ð¸Ñ‡ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ. Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð·Ð°ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚ÑŒÑ‚Ðµ Ð¸Ñ…"
    git status --short
    exit 1
fi

echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
npm ci

echo "ðŸ”¨ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚..."
npm run build

echo "ðŸŒ¿ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼/Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÐµÑ‚ÐºÑƒ deploy..."

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ deploy Ð²ÐµÑ‚ÐºÑƒ ÐµÑÐ»Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
git branch -D deploy 2>/dev/null || true

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ deploy Ð²ÐµÑ‚ÐºÑƒ
git checkout -b deploy

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ ÐºÑ€Ð¾Ð¼Ðµ .git
find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} +

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· out Ð² ÐºÐ¾Ñ€ÐµÐ½ÑŒ
cp -r out/* .
cp out/.htaccess . 2>/dev/null || true

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .gitignore Ð´Ð»Ñ deploy Ð²ÐµÑ‚ÐºÐ¸
cat > .gitignore << 'EOF'
# ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ .gitignore Ð´Ð»Ñ deploy Ð²ÐµÑ‚ÐºÐ¸
.DS_Store
Thumbs.db
EOF

echo "ðŸ“ ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼ deploy Ñ„Ð°Ð¹Ð»Ñ‹..."
git add .
git commit -m "deploy: $(date '+%Y-%m-%d %H:%M:%S')"

echo "ðŸ“¤ ÐŸÑƒÑˆÐ¸Ð¼ Ð² GitHub..."
git push origin deploy --force

echo "ðŸ”„ Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ÑÑ Ð½Ð° main Ð²ÐµÑ‚ÐºÑƒ..."
git checkout main

echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
echo ""
echo "ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo "1. Ð—Ð°Ð¹Ð´Ð¸Ñ‚Ðµ Ð½Ð° Ð²Ð°Ñˆ Ñ…Ð¾ÑÑ‚Ð¸Ð½Ð³ Ñ€ÐµÐ³.Ñ€Ñƒ Ð¿Ð¾ SSH"
echo "2. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² ÐºÐ¾Ñ€Ð½ÐµÐ²ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ ÑÐ°Ð¹Ñ‚Ð°: cd public_html"
echo "3. ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ deploy Ð²ÐµÑ‚ÐºÑƒ: git clone -b deploy https://github.com/Ð’ÐÐ¨_USERNAME/Ð’ÐÐ¨_Ð Ð•ÐŸÐž.git ."
echo "4. Ð”Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹: git pull origin deploy"
echo ""
echo "ðŸŒ Ð’Ð°Ñˆ ÑÐ°Ð¹Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð´Ð¾Ð¼ÐµÐ½Ð°!" 